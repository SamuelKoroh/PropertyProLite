<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta
      name="description"
      content="Property Pro Lite is a platform where people can create and/or
  search properties for sale or rent."
    />
    <title>Welcome to Property Pro</title>
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" />
  </head>
  <body>
    <header>
      <div class="container">
        <div class="brand">
          <h1><a href="index.html">PropertyPro</a></h1>
        </div>
        <nav>
          <ul>
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="add-property.html">New Ads</a></li>
            <li><a href="favourite.html">My Favourite</a></li>
            <li><a href="edit-profile.html">Update Profile</a></li>
            <li class="dropdown">
              <a href="javascript:void(0)" class="dropbtn">Admin</a>
              <div class="dropdown-content">
                <a href="manage-dealtype.html">Ads Types/Deals</a>
                <a href="manage-ads.html">Manage Ads</a>
                <a href="manage-user.html">Manage Users</a>
                <a href="manage-report.html">Reported Issues</a>
              </div>
            </li>
            <li id="signOut"><a href="signin.html">Sign Out</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="m-20">
      <div class="container" id="mainContainer">
        <p class=" lead text-success" id="welcomeUser"></p>

        <div class="mb-10 mt-30">
          <span class="lead text-primary" id="titleSpan">Manage Properties</span>
        </div>
      </div>
    </main>

    <!-- <div class="container center">
      <div class="pagination">
        <a href="#">&laquo;</a>
        <a href="#">1</a>
        <a href="#" class="active">2</a>
        <a href="#">3</a>
        <a href="#">4</a>
        <a href="#">5</a>
        <a href="#">6</a>
        <a href="#">&raquo;</a>
      </div>
    </div> -->
    <script src="./js/main.js"></script>
    <script>
      const token = localStorage.getItem('token');
      const userId = localStorage.getItem('userId');
      if (!token) window.location.href = `${BASE_URL}/`;

      const mainContainer = document.querySelector('#mainContainer');
      const titleSpan = document.querySelector('#titleSpan');
      const welcomeUser = document.querySelector('#welcomeUser');
      const signOut = document.querySelector('#signOut');

      welcomeUser.innerHTML = `<i class="fas fa-user" ></i> Welcome ${localStorage.getItem('userName')}`;

      fetch(`${API_URL}/api/v1/users/${userId}`)
        .then(response => response.json())
        .then(response => {
          const properties = response.data.userAdverts;
          mainContainer.innerHTML += `<table class="table">
          <thead>
            <tr>
              <th>Title</th>
              <th class="hide-sm">Type</th>
              <th class="hide-sm">Location</th>
              <th class="hide-sm">Price</th>
              <th>Mark As Sold</th>
              <th></th>
              <th></th>
            </tr>
          </thead>
          <tbody>
              ${(props = properties.map(
                prop =>
                  `<tr>
              <td>${prop.title}</td>
              <td class="hide-sm">${prop.type}</td>
              <td class="hide-sm">
                  ${prop.city},${prop.state}
              </td>
              <td class="hide-sm">
                #${prop.price}
              </td>
              <td>
                <label> <input type="checkbox" class="mark-property" name="status" ${(status =
                  prop.status === 'available' ? '  ' : 'checked  disabled')} data-property-id=${
                    prop.id
                  } /> Sold </label>
              </td>
              <td>
                <a href=edit-property.html?property_id=${prop.id} title="Edit this property" class="btn btn-primary"
                  ><i class="far fa-edit"></i><span class="hide-sm">Edit</span>
                </a>
              </td>
              <td>
                <button class="btn btn-danger delete-property" data-property-id=${prop.id} title="Remove this property">
                  Delete
                </button>
              </td>
            </tr>`
              )).join(' ')}
          </tbody>
        </table>`;

          const checboxes = document.querySelectorAll('.mark-property');
          const buttons = document.querySelectorAll('button.delete-property');

          buttons.forEach(button => {
            button.addEventListener('click', ({ target }) => {
              if (!confirm('Do you to remove this AD')) return;
              const propId = target.getAttribute('data-property-id');

              fetch(`${API_URL}/api/v1/property/${propId}`, {
                method: 'DELETE',
                headers: { token }
              })
                .then(response => response.json())
                .then(response => {
                  const { error, data } = response;
                  if (error) return alert(error);
                  alert(data.message);
                  const row = target.parentNode.parentNode;
                  row.parentNode.removeChild(row);
                });
            });
          });
          checboxes.forEach(checkbox => {
            checkbox.addEventListener('click', ({ target }) => {
              const propId = target.getAttribute('data-property-id');
              fetch(`${API_URL}/api/v1/property/${propId}/sold`, {
                method: 'PATCH',
                headers: { token }
              })
                .then(response => response.json())
                .then(response => {
                  const { error } = response;
                  error ? alert(error) : target.setAttribute('disabled', true);
                });
            });
          });
        })
        .catch(error => console.log(error));

        signOut.addEventListener('click',()=>{
          localStorage.removeItem('token');
          localStorage.removeItem('userName');
          localStorage.removeItem('userId');
        })
    </script>
    <footer>
      <p>All right reserved PropertyPro &copy; 2019</p>
    </footer>
  </body>
</html>
